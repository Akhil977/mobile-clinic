<!DOCTYPE html>
<html>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
<%- include ('component/head.ejs') %> 
<body class="hold-transition skin-blue sidebar-mini">
<div class="wrapper">
  <%- include ('component/header.ejs') %> 
  <%- include ('component/aside.ejs') %> 

  <!-- Content Wrapper. Contains page content -->
  <div class="content-wrapper">
    <!-- Content Header (Page header) -->
    <section class="content-header">
      <h1>
        Order Management
        <small>Admin Control Panel</small>
      </h1>
      <ol class="breadcrumb">
        <li><a href="#"><i class="fa fa-dashboard"></i> Home</a></li>
        <li class="active">Order Management</li>
      </ol>
    </section>

    <!-- Main content -->
    <section class="content">
      <!-- Orders Table -->
      <div class="box">
        <div class="box-header">
          <h3 class="box-title">Orders</h3>
        </div>
        <div class="box-body">
          <table class="table table-bordered">
            <thead>
              <tr>
                <th>Order ID</th>
                <th>User Details</th>
                <th>Date</th>
                <th>Total Amount</th>
                <th>Status</th>
                <th>Return Status</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
              <% orders.forEach(order => { %>
              <tr>
                <td><%= order.orderId %></td>
                <td>
                  <% if (order.userName && order.userName !== 'Unknown User') { %>
                    <strong><%= order.userName %></strong>
                    <% if (order.userEmail) { %>
                      <br><small><%= order.userEmail %></small>
                    <% } %>
                  <% } else { %>
                    <strong>No User Data</strong>
                  <% } %>
                </td>
                <td><%= order.date ? new Date(order.date).toLocaleDateString() : 'N/A' %></td>
                <td>$<%= order.finalAmount %></td>
                <td>
                    <% if (['Request Return', 'Return Approved', 'Return Rejected', 'Return Completed'].includes(order.status)) { %>
                      <strong>Delivered</strong>
                    <% } else { %>
                      <select class="form-control status-dropdown" data-id="<%= order._id %>" data-type="status">
                        <option value="Pending" <%= order.status === 'Pending' ? 'selected' : '' %>>Pending</option>
                        <option value="Processing" <%= order.status === 'Processing' ? 'selected' : '' %>>Processing</option>
                        <option value="Shipped" <%= order.status === 'Shipped' ? 'selected' : '' %>>Shipped</option>
                        <option value="Cancelled" <%= order.status === 'Cancelled' ? 'selected' : '' %>>Cancelled</option>
                        <option value="Delivered" <%= order.status === 'Delivered' ? 'selected' : '' %>>Delivered</option>
                      </select>
                    <% } %>
                  </td>
                  
                  <td>
                    <% if (['Request Return', 'Return Approved', 'Return Rejected', 'Return Completed'].includes(order.status)) { %>
                      <select class="form-control status-dropdown" data-id="<%= order._id %>" data-type="status">
                        <option value="Request Return" <%= order.status === 'Request Return' ? 'selected' : '' %>>Request Return</option>
                        <option value="Return Approved" <%= order.status === 'Return Approved' ? 'selected' : '' %>>Return Approved</option>
                        <option value="Return Rejected" <%= order.status === 'Return Rejected' ? 'selected' : '' %>>Return Rejected</option>
                        <option value="Return Completed" <%= order.status === 'Return Completed' ? 'selected' : '' %>>Return Completed</option>
                      </select>
                    <% } else { %>
                      <%= order.returnStatus || 'N/A' %>
                    <% } %>
                  </td>
                <td><a href="/admin/orderDetails?_id=<%= order._id %>&user_id=<%= order.userId %>" class="btn btn-primary btn-sm">View</a></td>
              </tr>
              <% }); %>
            </tbody>
          </table>
        </div>
      </div>

    </section>
  </div>
  
  <%- include ('component/footer.ejs') %>
</div>

  <!-- Toastr JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

  <script>
    $(document).ready(function() {
      // Configure Toastr defaults
      toastr.options = {
        "closeButton": true,
        "debug": false,
        "newestOnTop": false,
        "progressBar": true,
        "positionClass": "toast-top-right",
        "preventDuplicates": true,
        "onclick": null,
        "showDuration": "300",
        "hideDuration": "1000",
        "timeOut": "5000",
        "extendedTimeOut": "1000",
        "showEasing": "swing",
        "hideEasing": "linear",
        "showMethod": "fadeIn",
        "hideMethod": "fadeOut"
      };

      // Single event handler for both status and return status
      $(".status-dropdown").on("change", function() {
        const orderId = $(this).data("id");
        const statusType = $(this).data("type");
        const newValue = $(this).val();
        
        // Create the query parameters
        const params = new URLSearchParams({
          orderId: orderId,
          statusType: statusType,
          value: newValue
        });

        // Send request to unified update endpoint
        fetch(`/admin/update-order-status?${params}`, {
          method: "PATCH",
          headers: { 
            "Content-Type": "application/json" 
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            const statusLabel = statusType === 'returnStatus' ? 'Return status' : 'Order status';
            toastr.success(`${statusLabel} updated to ${newValue}`, "Status Updated");
            
            // Delay reload to ensure toastr is visible
            setTimeout(() => {
              location.reload();
            }, 1000);
          } else {
            toastr.error(data.message || "Failed to update status", "Update Failed");
          }
        })
        .catch(error => {
          console.error("Error updating status:", error);
          toastr.error("Something went wrong. Please try again.", "Error");
        });
      });
    });
  </script>

</body>
</html>